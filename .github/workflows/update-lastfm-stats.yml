name: Update Last.fm Stats

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´0ç‚¹è¿è¡Œï¼ˆå¯¹åº”åŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹ï¼‰ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´cronè¡¨è¾¾å¼
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write # èµ‹äºˆå·¥ä½œæµå†™å…¥ä»“åº“çš„æƒé™

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch Last.fm Data
        id: fetch
        env:
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          LASTFM_USERNAME: ${{ secrets.LASTFM_USERNAME }} # æˆ–è€…ç›´æŽ¥å†™æ­»ï¼š'YOUR_LASTFM_USERNAME'
        run: |
          # è°ƒç”¨Last.fm APIï¼ŒèŽ·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå…¶ä¸­åŒ…å«æ€»æ’­æ”¾é‡ï¼‰
          RESPONSE=$(curl -s "https://ws.audioscrobbler.com/2.0/?method=user.getinfo&user=${LASTFM_USERNAME}&api_key=${LASTFM_API_KEY}&format=json")
          
          # ä½¿ç”¨jqè§£æžJSONï¼Œæå–æ€»æ’­æ”¾æ•°ã€‚å¦‚æžœæ²¡æœ‰jqå‘½ä»¤ï¼Œä¸‹ä¸€è¡Œä¼šå®‰è£…å®ƒã€‚
          sudo apt-get install -y jq > /dev/null 2>&1 || true
          TOTAL_PLAYS=$(echo $RESPONSE | jq -r '.user.playcount // 0')
          
          # è¾“å‡ºèŽ·å–åˆ°çš„æ’­æ”¾é‡ï¼Œä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "total_plays=$TOTAL_PLAYS" >> $GITHUB_OUTPUT
          
          # åŒæ—¶åˆ›å»ºä¸€ä¸ªåŒ…å«æ’­æ”¾é‡çš„JSONæ–‡ä»¶
          echo "{\"playcount\": $TOTAL_PLAYS, \"updated_at\": \"$(date -Iseconds)\"}" > lastfm_data.json
          
          echo "ðŸŽµ Successfully fetched data. Total Plays: $TOTAL_PLAYS"

      - name: Commit and Push if Changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add -A
          git commit -m "ðŸ¤– chore: update Last.fm stats [skip ci]" || echo "No changes to commit"
          git push